#!/bin/bash
# ---------------------------------------------------
#  Tasmota devices network discovery
# 
# Revision history :
#   15/04/2019, V1.0 - Creation by N. Bernaerts
#   17/04/2019, V1.1 - Adjust timeout and retries
#   18/04/2019, V1.2 - Add MQTT topic
#   23/05/2020, V1.3 - Use /version page
# ---------------------------------------------------

#   Check tools availability
command -v fping >/dev/null 2>&1 || { echo "[error] Please install fping"; exit 1; }
command -v wget >/dev/null 2>&1 || { echo "[error] Please install wget"; exit 1; }

# get first adapter netmask
NETMASK=$(ip addr | grep inet | grep brd | head -n 1 | xargs | cut -d' ' -f2)
echo "Netmask is ${NETMASK}"

# load array from fping
ARR_IP=( $(fping --addr --retry=2 --generate "${NETMASK}" 2>/dev/null | grep "alive" | cut -d' ' -f1) )

# display number of IP
NBR_IP="${#ARR_IP[@]}"
echo "Found ${NBR_IP} IP addresses"

# loop thru IP addresses
for IP in "${ARR_IP[@]}"
do
	# display current IP
	echo -ne "${IP}\r"

	# read page /version
	TASMOTA_DATA=$(wget --quiet --tries=1 --timeout=5 -O - "http://${IP}/version" | tr -d "\"{}" | tr "," "\n")
	TASMOTA_MODULE=$(echo "${TASMOTA_DATA}" | grep "Module:" | cut -d':' -f2)

	# if not available, read page /in (doesn't work if password set)
	if [ "${TASMOTA_MODULE}" = "" ]
	then
		TASMOTA_DATA=$(wget --quiet --tries=1 --timeout=5 -O - "http://${IP}/in" | sed "s|}2|:|g" | sed "s|}1|\n|g" | tr ">" "\n")
		TASMOTA_MODULE=$(wget --quiet --tries=1 --timeout=5 -O - "http://${IP}/" | grep "Tasmota" | tr "<" "\n" | grep "^h3" | cut -d'>' -f2 | sed "s| Module||g")
	fi

	# if data are read, we are dealing with tasmota module
	if [ "${TASMOTA_MODULE}" != "" ] 
	then
		# read data
		TASMOTA_VERSION=$(echo "${TASMOTA_DATA}" | grep "Program Version:" | cut -d':' -f2)
		TASMOTA_HOSTNAME=$(echo "${TASMOTA_DATA}" | grep "Hostname" | cut -d':' -f2)
		TASMOTA_UPTIME=$(echo "${TASMOTA_DATA}" | grep "Uptime:" | cut -d':' -f2-)
		TASMOTA_MQTT=$(echo "${TASMOTA_DATA}" | grep "MQTT Full Topic:" | cut -d':' -f2-)
		EXTENSION_TYPE=$(echo "${TASMOTA_DATA}" | grep "Extension type:" | cut -d':' -f2)
		EXTENSION_VERSION=$(echo "${TASMOTA_DATA}" | grep "Extension version:" | cut -d':' -f2)
	fi

	# display
	if [ "${TASMOTA_MODULE}" != "" ]
	then
		DISPLAY="${IP} [${TASMOTA_HOSTNAME}] ${TASMOTA_MODULE}, Tasmota ${TASMOTA_VERSION},"
		[ "${EXTENSION_TYPE}" != "" ] && DISPLAY="${DISPLAY} ${EXTENSION_TYPE} ${EXTENSION_VERSION},"
		DISPLAY="${DISPLAY} Up ${TASMOTA_UPTIME}, MQTT ${TASMOTA_MQTT}"
		echo "${DISPLAY}"
	fi
done

